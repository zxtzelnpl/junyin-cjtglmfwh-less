<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>资料上传</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=2, minimum-scale=1"/>
    <link rel="stylesheet" href="/mobile/libs/normalize-css/normalize.css">
    <link rel="stylesheet" href="/mobile/libs/jquery-toast-plugin/dist/jquery.toast.min.css">
    <link rel="stylesheet" href="/mobile/css/videouploadAndroid.css">
    <link rel="stylesheet" href="/mobile/css/iosStopFontScale.css">
    <link rel="stylesheet" href="/mobile/css/fontScale.css">
</head>
<body>
<form>
    <div class="container material-upload">
        <div class="prompt canScale">
            <h4>视频录音文字</h4>
            <p>本人<span>田雨橙</span>，身份证号：<span>311111111111111111</span>，对适当性评估结果已知悉，自愿并亲自签署相关风险揭示书及投顾协议等文件。
            </p>
        </div>

        <div class="videoBox">
            <video controls autoplay></video>
        </div>

        <div class="blank-h-30"></div>

        <div class="videoBtnBox">
            <div class="btnBeginRecord btn active" id="btnBeginRecord">开始录制</div>
            <div class="btnStopRecord btn" id="btnStopRecord">停止录制</div>
        </div>
    </div>
</form>
</body>
<script src="/mobile/libs/jquery/dist/jquery.min.js"></script>
<script src="/mobile/libs/jquery-toast-plugin/dist/jquery.toast.min.js"></script>
<script src="/mobile/javascript/androidStopFontScale.js"></script>
<script src="/mobile/javascript/selfFontScale.js"></script>
<script src="/mobile/javascript/inLoading.js"></script>
<script src="/mobile/javascript/RecordRTC.js"></script>
<script src="/mobile/javascript/adapter-latest.js"></script>
<script>
  function toast(message) {
    $.toast({
      text: message,
      allowToastClose: false,
      showHideTransition: 'slide',
      position: 'bottom-center',
      hideAfter: 1500,
      stack: false,
      textAlign: 'center',
      loader: false
    })
  }

  $(function () {
    var video = document.querySelector('video')
      , recorder
      , options = {
      recorderType: MediaStreamRecorder,
      mimeType: 'video/webm;codecs=vp8'
    }
      , btnBeginRecord = document.getElementById('btnBeginRecord')
      , btnStopRecord = document.getElementById('btnStopRecord')
      , InLoading = null
      , STATE = 0
      , state_records = ["准备录制", "录制中", "数据上传中", "数据上传完毕"] //3

    function captureCamera(callback) {
      navigator.mediaDevices.getUserMedia({audio: true, video: true}).then(function (camera) {
        callback(camera);
      }).catch(function (error) {
        alert('Unable to capture your camera. Please check console logs.');
        alert(error.message)
      });
    }

    function stopRecordingCallback() {
      var blob = recorder.getBlob();
      recorder.camera.stop();


      setTimeout(function () {
        STATE++;
        $("body").data("InLoading").hide()

        ableBtn(btnBeginRecord)
        btnBeginRecord.innerHTML = "重新录制"

        ableBtn(btnStopRecord)
        btnStopRecord.innerHTML = "提交"

        recorder.destroy();
        recorder = null;
      }, 2000)

      // 正式的代码
      /*var fileType = 'video'; // or "audio"
      var fileName = 'ABCDEF.webm';  // or "wav"
      var formData = new FormData();
      formData.append(fileType + '-filename', fileName);
      formData.append(fileType + '-blob', blob);
      xhr('/RecordRTC/PostRecordedAudioVideo', formData, function (fName) {
        STATE++;
        $("body").data("InLoading").hide()

        ableBtn(btnBeginRecord)
        btnBeginRecord.innerHTML = "重新录制"

        ableBtn(btnStopRecord)
        btnStopRecord.innerHTML = "提交"

        recorder.destroy();
        recorder = null;
      });*/
      // 正式的代码

    }

    btnBeginRecord.onclick = function () {
      if (STATE === 0 || STATE === 3) {
        captureCamera(function (camera) {
          btnBeginRecord.innerHTML = "录制中"
          btnStopRecord.innerHTML = "停止录制"
          disableBtn(btnBeginRecord)

          setSrcObject(camera, video);
          video.play();
          recorder = RecordRTC(camera, options);
          recorder.startRecording();
          // release camera on stopRecording
          recorder.camera = camera;

          ableBtn(btnStopRecord);
        });

        STATE = 1;
      }
      else {
        return toast(state_records[STATE]);
      }
    };

    btnStopRecord.onclick = function () {
      if (STATE === 1) {
        STATE++
        disableBtn(btnStopRecord);
        if (InLoading) {
          InLoading.show();
        }
        else {
          InLoading = $("body").InLoading().data("InLoading")
        }

        recorder.stopRecording(stopRecordingCallback);
      }
      else if (STATE === 3) {
        return toast("跳向下一页")
      }
      else {
        return toast(state_records[STATE]);
      }
    }

    function disableBtn(btn) {
      var __className = btn.className.split(" ")
        , className = __className.filter(function (value) {
        return value !== 'active'
      })
      btn.className = className.join(" ")

    }

    function ableBtn(btn) {
      var className = btn.className
      btn.className = className + " active"
    }

    function xhr(url, data, callback) {
      var request = new XMLHttpRequest();
      request.onreadystatechange = function () {
        if (request.readyState == 4 && request.status == 200) {
          callback(location.href + request.responseText);
        }
      };
      request.open('POST', url);
      request.send(data);
    }
  })
</script>
</html>